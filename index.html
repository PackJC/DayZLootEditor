<!DOCTYPE html>
<html lang="eng">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js"
            integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>
    <link href="./node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet" crossorigin="anonymous">
    <link href="./styles.css" rel="stylesheet">
    <title>DayZ : XML Editor Suite</title>
</head>
<body>
<nav class="navbar navbar-expand navbar-light border-dark border-bottom bg-dark"
     style="background-color: rgba(0, 0, 0, 0.2);">
    <ul class="navbar-nav p-0">
        <li class="nav-item align-self-center p-1">
            <img src="./media/DayZLogo.png" class="img-fluid" alt="DayZ Logo"/>
        </li>
        <li class="nav-item p-3 align-self-center active">
            <button class="nav-link btn btn-warning" id="getFile">Import XML Files</button>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link btn btn-warning disabled save-btn" id="saveFile">Save</a>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link  btn btn-warning" id="help">Settings</a>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link  btn btn-danger" id="test">TEST EXPORT</a>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link  btn btn-danger" id="export">EXPORT</a>
        </li>
    </ul>
</nav>
<br>
<label for="myInput"></label><input class="form-control" id="myInput" type="text"
                                    placeholder="Search Table 'Food', 'Military', 'ACOG' ">
<br>
<table class="table table-striped table-responsive" id="myTable">
    <thead>
    <tr class="justify-content-center">
        <th title="">name</th>
        <th title="Amount of the item allowed on the entire map">nominal</th>
        <th title="Lifetime of an item once it is spawned in seconds">lifetime</th>
        <th title="Amount of time that will need to pass before an item is allowed to spawn again">restock</th>
        <th title="Amount of an item that will spawn on the map">min</th>
        <th title="Minimum quantity of consumable within the item">quantmin</th>
        <th title="Maximum quantity of consumable within the item">quantmax</th>
        <th title="category">category</th>
        <th title="Determines the spawn chance of an item">cost</th>
        <th title="Count for this weapon will include inventory of vehicles towards Max">count_in_cargo</th>
        <th title="Count for this weapon will include inventory of containers that can be moved/placed/built by a player (barrels/sea chest/tent/backpack/protector case) towards Max">
            count_in_hoarder
        </th>
        <th title="Count for this weapon will include items in/on map towards Max.">count_in_map</th>
        <th title="Count for this weapon will include Player Inventory and Player Hands towards weapon Max">
            count_in_player
        </th>
        <th title="Used only to mark player craftable items">crafted</th>
        <th title="Dynamic Event Loot, the items and weapons that usually spawn around Helicopter Crash Sites">deloot
        </th>
        <th>usage</th>
        <th>value</th>
        <th>tag</th>
    </tr>
    </thead>
    <tbody id="myTBody">
    </tbody>
</table>
</body>
<footer class="bg-dark text-center text-warning fixed-bottom border-dark border-top">
    <div class="text-center" style="background-color: rgba(0, 0, 0, 0.2);">
        Â© 2022 PackJC Version 0.90
    </div>
</footer>
</html>

<script>
    //Import
    const {ipcRenderer, app} = require("electron");
    const xml2js = require("xml2js");
    const electron = require("electron");
    const {writeFile} = require("fs");
    let xmlDoc;
    //Event Listeners
    document.getElementById("getFile").addEventListener("click", getFileFunction);
    document.getElementById("saveFile").addEventListener("click", saveFileFunction);
    document.getElementById("help").addEventListener("click", getHelp);
    document.getElementById("test").addEventListener("click", getTest);
    document.getElementById("export").addEventListener("click", sendXML);

    //IPC
    ipcRenderer.on("receiveDataReply", (event, data) => {
        console.log("successful file upload")
        let loopCounter = data.types.type.length
        let table = document.getElementById('myTBody')
        for (let i = 0; i < loopCounter; i++) {
            let row = table.insertRow(0)
            let category = data.types.type[i]?.category?.[0].$?.name ?? "N / A"
            let usage1 = data.types.type[i]?.usage?.[0].$?.name ?? "N / A"
            let value1 = data.types.type[i]?.value?.[0].$?.name ?? "N / A"
            let tag = data.types.type[i].tag?.[0].$?.name ?? "N / A"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + tag + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + value1 + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + usage1 + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].flags[0].$.deloot + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].flags[0].$.crafted + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].flags[0].$.count_in_player + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].flags[0].$.count_in_map + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].flags[0].$.count_in_hoarder + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].flags[0].$.count_in_cargo + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].cost + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + category + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].quantmax + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].quantmin + "</div>" //11
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].min + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].restock + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].lifetime + "</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>" + data.types.type[i].nominal + "</div>"
            row.insertCell(0).innerHTML = "<div>" + data.types.type[i].$.name + "</div>"
        }
        document.querySelector('.save-btn').classList.remove('disabled')
    })
    ipcRenderer.on("updateImportButton", (event, data) => {
        document.getElementById('getFile').innerHTML = data.toString()
    })

    //Functions
    function getFileFunction() {
        ipcRenderer.send("getFileEvent")
    }

    function checkJSON() {
        ipcRenderer.send("checkJSON")
    }

    function sendXML(){
        let doc1 = "THE DATA HAS BEEN RECEIVED"
        //let doc1 = getTest();
        ipcRenderer.send("doc", doc1);
    }

    function saveFileFunction() {
        ipcRenderer.send("saveFileEvent")
    }

    function getTest() {
        const parser = new DOMParser()
        const table = $('#myTable').tableToJSON()
        const typeArr = {"type": table}
        const typesArray = {"types": typeArr}
        const builder = new xml2js.Builder()
        const xml = builder.buildObject(typesArray)
        xmlDoc = parser.parseFromString(xml, "application/xml")
        let xmlNodes = xmlDoc.getElementsByTagName("type")
        console.log('i Loops: ' + xmlNodes.length)
        for (let i = 0; i < xmlNodes.length; i++) {
            //Add name attribute to Type
            xmlNodes[i].setAttribute("name", xmlNodes[i].childNodes[1].firstChild.nodeValue)
            //Remove name node since it's added as attribute now
            xmlNodes[i].childNodes[1].remove()
            let newText = xmlDoc.createElement("flags");
            xmlNodes[i].appendChild(newText)
        }

        let node, childNodes = xmlDoc.documentElement.childNodes;
        console.log('z Loops: ' + childNodes.length)
        for (let z = 0; z < childNodes.length; z++) {

            if (childNodes[z].nodeType !== Node.TEXT_NODE) {
                node = childNodes[z];
                /*
                Sets attribute for XML Nodes
                */
                node.getElementsByTagName('flags')[0]?.setAttribute("count_in_cargo", node.getElementsByTagName('count_in_cargo')[0]?.textContent)
                node.getElementsByTagName('flags')[0]?.setAttribute("count_in_hoarder", node.getElementsByTagName('count_in_hoarder')[0]?.textContent)
                node.getElementsByTagName('flags')[0]?.setAttribute("count_in_map", node.getElementsByTagName('count_in_map')[0]?.textContent)
                node.getElementsByTagName('flags')[0]?.setAttribute("count_in_player", node.getElementsByTagName('count_in_player')[0]?.textContent)
                node.getElementsByTagName('flags')[0]?.setAttribute("crafted", node.getElementsByTagName('crafted')[0]?.textContent)
                node.getElementsByTagName('flags')[0]?.setAttribute("deloot", node.getElementsByTagName('deloot')[0]?.textContent)
                node.getElementsByTagName('tag')[0]?.setAttribute("name", node.getElementsByTagName('tag')[0]?.textContent)
                node.getElementsByTagName('category')[0]?.setAttribute("name", node.getElementsByTagName('category')[0]?.textContent)
                node.getElementsByTagName('usage')[0]?.setAttribute("name", node.getElementsByTagName('usage')[0]?.textContent)
                node.getElementsByTagName('value')[0]?.setAttribute("name", node.getElementsByTagName('value')[0]?.textContent)
                //node.getElementsByTagName('usage')[1]?.setAttribute("name", node.getElementsByTagName('usage')[1]?.textContent)
                //node.getElementsByTagName('value')[1]?.setAttribute("name", node.getElementsByTagName('value')[1]?.textContent)
                //node.getElementsByTagName('usage')[2]?.setAttribute("name", node.getElementsByTagName('usage')[2]?.textContent)
                //node.getElementsByTagName('value')[2]?.setAttribute("name", node.getElementsByTagName('value')[2]?.textContent)
                /*
                Removes Undefined XML Nodes
                */
                if (node.getElementsByTagName('category')[0]?.textContent === "undefined" || node.getElementsByTagName('category')[0]?.textContent === "N / A") {
                    node.getElementsByTagName('category')[0].remove()
                }
                if (node.getElementsByTagName('tag')[0]?.textContent === "undefined" || node.getElementsByTagName('tag')[0]?.textContent === "N / A") {
                    node.getElementsByTagName('tag')[0].remove()
                }
                if (node.getElementsByTagName('usage')[0]?.textContent === "undefined" || node.getElementsByTagName('usage')[0]?.textContent === "N / A") {
                    node.getElementsByTagName('usage')[0].remove()
                }
                if (node.getElementsByTagName('value')[0]?.textContent === "undefined" || node.getElementsByTagName('value')[0]?.textContent === "N / A") {
                    node.getElementsByTagName('value')[0].remove()
                }
                /*
                Removes XML Node Text
                 */
                if (node.getElementsByTagName('tag')[0]?.textContent !== "undefined") {
                    let tagNode = node?.getElementsByTagName('tag')[0]
                    if (tagNode) {
                        tagNode.textContent = ""
                    }
                }
                if (node.getElementsByTagName('category')[0]?.textContent !== "undefined") {
                    let categoryNode = node?.getElementsByTagName('category')[0]
                    if (categoryNode) {
                        categoryNode.textContent = ""
                    }
                }
                if (node.getElementsByTagName('value')[0]?.textContent !== "undefined") {
                    let categoryNode = node?.getElementsByTagName('value')[0]
                    if (categoryNode) {
                        categoryNode.textContent = ""
                    }
                }
                if (node.getElementsByTagName('usage')[0]?.textContent !== "undefined") {
                    let categoryNode = node?.getElementsByTagName('usage')[0]
                    if (categoryNode) {
                        categoryNode.textContent = ""
                    }
                }
            }
        }

        for (let h = 0; h < childNodes.length; h++) {
            if (childNodes[h].nodeType !== Node.TEXT_NODE) {
                node = childNodes[h];
                node.getElementsByTagName('count_in_cargo')[0]?.remove()
                node.getElementsByTagName('count_in_hoarder')[0]?.remove()
                node.getElementsByTagName('count_in_map')[0]?.remove()
                node.getElementsByTagName('count_in_player')[0]?.remove()
                node.getElementsByTagName('crafted')[0]?.remove()
                node.getElementsByTagName('deloot')[0]?.remove()
            }
        }

        return xmlDoc;
    }

    function getHelp() {
        //Help page redirect
        window.location.href = "settings.html";
    }

    //jQuery for table search box
    $(document).ready(function () {
        $("#myInput").on("keyup", function () {
            let value = $(this).val().toLowerCase();
            $("#myTable tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });
</script>