<!DOCTYPE html>
<html lang="eng">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js"
            integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>
    <link href="./node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet" crossorigin="anonymous">
    <link href="./styles.css" rel="stylesheet">
    <title>DayZ : XML Editor Suite</title>
</head>
<body>
<nav class="navbar navbar-expand navbar-light border-dark border-bottom bg-dark"
     style="background-color: rgba(0, 0, 0, 0.2);">
    <ul class="navbar-nav p-0">
        <li class="nav-item align-self-center p-1">
            <img src="./media/DayZLogo.png" class="img-fluid" alt="DayZ Logo"/>
        </li>
        <li class="nav-item p-3 align-self-center active">
            <button class="nav-link btn btn-warning" id="getFile">Import XML Files</button>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link btn btn-warning disabled save-btn" id="saveFile">Save</a>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link  btn btn-warning" id="help">Help</a>
        </li>
        <li class="nav-item p-3 align-self-center">
            <a class="nav-link  btn btn-danger" id="test">Settings[TEST]</a>
        </li>
    </ul>
</nav>
<br>
<label for="myInput"></label><input class="form-control" id="myInput" type="text"
                                    placeholder="Search Table 'Food', 'Military', 'ACOG' ">
<br>
<table class="table table-striped table-responsive" id="myTable">
    <thead>
    <tr class="justify-content-center">
        <th title="">name</th>
        <th title="Amount of the item allowed on the entire map">nominal</th>
        <th title="Lifetime of an item once it is spawned in seconds">lifetime</th>
        <th
                title="Amount of time that will need to pass before an item is allowed to spawn again">restock
        </th>
        <th title="Amount of an item that will spawn on the map">min</th>
        <th title="Minimum quantity of consumable within the item">quantmin</th>
        <th title="Maximum quantity of consumable within the item">quantmax</th>
        <th title="category">category</th>
        <th title="Determines the spawn chance of an item">cost</th>
        <th title="Count for this weapon will include inventory of vehicles towards Max">count_in_cargo
        </th>
        <th title="Count for this weapon will include inventory of containers that can be moved/placed/built by a player (barrels/sea chest/tent/backpack/protector case) towards Max">
            count_in_hoarder
        </th>
        <th title="Count for this weapon will include items in/on map towards Max.">count_in_map
        </th>
        <th title="Count for this weapon will include Player Inventory and Player Hands towards weapon Max">
            count_in_player
        </th>
        <th title="Used only to mark player craftable items">crafted</th>
        <th
                title="Dynamic Event Loot, the items and weapons that usually spawn around Helicopter Crash Sites">
            deloot
        </th>
        <th>
            usage
        </th>
        <th>
            value
        </th>
        <th>
            tag
        </th>
    </tr>
    </thead>
    <tbody id="myTBody">
    </tbody>
</table>
</body>
<footer class="bg-dark text-center text-warning fixed-bottom border-dark border-top">
    <div class="text-center" style="background-color: rgba(0, 0, 0, 0.2);">
        Â© 2022 PackJC Version 0.80
    </div>
</footer>
</html>

<script>
    //Import
    const {ipcRenderer} = require("electron");
    const xml2js = require("xml2js");

    //Event Listeners
    document.getElementById("getFile").addEventListener("click", getFileFunction);
    document.getElementById("saveFile").addEventListener("click", saveFileFunction);
    document.getElementById("help").addEventListener("click", getHelp);
    document.getElementById("test").addEventListener("click", getTest);
    document.getElementById("test").addEventListener("click", checkJSON);

    //IPC
    ipcRenderer.on("receiveDataReply", (event, data) => {
        console.log("successful file upload")
        /*
        function categoryLoop(element) {
            if (element?.category?.length === 1) {
                for (let x = 0; x < element.category.length; x++) {
                    return (element?.category?.[0]?.$?.name)
                }
            } else {
                return ""
            }
        }
        */

        let loopCounter = data.types.type.length
        let table = document.getElementById('myTBody')
        for (let i = 0; i < loopCounter; i++) {
            row = table.insertRow(0)
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].tag?.[0].$.name+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].value?.$?.name+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].usage?.$?.name+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].flags[0].$.deloot+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].flags[0].$.crafted+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].flags[0].$.count_in_player+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].flags[0].$.count_in_map+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].flags[0].$.count_in_hoarder+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].flags[0].$.count_in_cargo+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].cost+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i]?.category?.[0].$?.name+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].quantmax+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].quantmin+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].min+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].restock+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].lifetime+"</div>"
            row.insertCell(0).innerHTML = "<div contentEditable='true'>"+data.types.type[i].nominal+"</div>"
            row.insertCell(0).innerHTML = "<div>"+data.types.type[i].$.name+"</div>"
        }
        document.querySelector('.save-btn').classList.remove('disabled')
    })
    ipcRenderer.on("checkJSON", (event, data) => {
        //Change import button to local file path
        console.log(data)
    })
    ipcRenderer.on("updateImportButton", (event, data) => {
        //Change import button to local file path
        document.getElementById('getFile').innerHTML = data.toString()
    })

    //Functions
    function getFileFunction() {
        ipcRenderer.send("getFileEvent")
    }

    function checkJSON() {
        ipcRenderer.send("checkJSON")
    }

    function saveFileFunction() {
        ipcRenderer.send("saveFileEvent")
    }

    function getTest() {
        const parser = new DOMParser()
        const table = $('#myTable').tableToJSON()
        const typeArr = {"type": table}
        const typesArray = {"types": typeArr}
        const builder = new xml2js.Builder()
        const xml = builder.buildObject(typesArray)
        const xmlDoc = parser.parseFromString(xml, "application/xml")
        let xmlNodes = xmlDoc.getElementsByTagName("type")
        for (let i = 0; i < xmlNodes.length; i++) {
            //Add name attribute to Type
            xmlNodes[i].setAttribute("name", xmlNodes[i].childNodes[1].firstChild.nodeValue)
            //Remove name node since it's added as attribute now
            xmlNodes[i].childNodes[1].remove()
            var node, childNodes = xmlDoc.documentElement.childNodes;
            for(var z = 0; z < childNodes.length; z++)
            {
                node = childNodes[z];
                if(node.nodeType !== Node.TEXT_NODE){
                    if(node.getElementsByTagName('category')[0]?.textContent === "undefined"){
                        //console.log('REMOVE UNDEFINED HERE')
                        //console.log(node.getElementsByTagName('category')[0]?.textContent)
                        //Remove undefined element
                        node.getElementsByTagName('category')[0].remove()
                        //xmlNodes[i].childNodes[z].remove()

                    }

                    else if(node.getElementsByTagName('tag')[0]?.textContent !== "undefined"){
                        node.getElementsByTagName('tag')[0]?.setAttribute("name", node.getElementsByTagName('tag')[0]?.textContent)
                       // node.getElementsByTagName('tag')[0] = ("test")
                        //remove inner text of element here
                    }
                    else if(node.getElementsByTagName('tag')[0]?.textContent === "undefined"){
                        //Remove undefined element
                        node.getElementsByTagName('tag')[0].remove()
                        //xmlNodes[i].childNodes[z].remove()

                    }


                }
            }

        }
        console.log(xmlDoc)
    }

    function getHelp() {
        //Help page redirect
        window.location.href = "help.html";
    }

    //jQuery for table search box
    $(document).ready(function () {
        $("#myInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#myTable tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });
</script>